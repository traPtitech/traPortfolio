name: CI

on:
  push:
    branches:
      - 'main'
  pull_request:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version-file: ./go.mod
          cache: true
      - name: Download go modules
        run: go mod download
      - name: Compile go packages
        run: go build -o traPortfolio .
      - uses: actions/upload-artifact@v3
        with:
          name: traPortfolio
          path: traPortfolio
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run linters
        uses: reviewdog/action-golangci-lint@v2
        with:
          filter_mode: nofilter
  test-unit:
    name: Test (Unit)
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version-file: ./go.mod
          cache: true
      - name: Run tests
        run: go test $(go list ./... | grep -v "integration_tests") -coverprofile=coverage_unit.txt -race -vet=off
      - uses: actions/upload-artifact@v3
        with:
          name: coverages
          path: coverage_unit.txt
  test-integration:
    name: Test (Integration)
    runs-on: ubuntu-latest
    needs:
      - build
    services:
      mysql:
        image: mariadb:10.6.4
        options: --health-cmd="mysqladmin ping" --health-interval=5s --health-timeout=2s --health-retries=3
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: portfolio
        ports:
          - 3307:3306
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version-file: ./go.mod
          cache: true
      - name: Run tests
        run: go test ./integration_tests/... -coverpkg=./... -coverprofile=coverage_integration.txt -race -vet=off
      - uses: actions/upload-artifact@v3
        with:
          name: coverages
          path: coverage_integration.txt
  upload-codecov:
    name: Analyze coverages
    runs-on: ubuntu-latest
    needs:
      - test-unit
      - test-integration
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: coverages
      - name: Upload coverage data (Unit)
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage_unit.txt
          flags: unit
      - name: Upload coverage data (Integration)
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage_integration.txt
          flags: integration
  tbls:
    name: TBLS
    runs-on: ubuntu-latest
    needs:
      - build
    services:
      mysql:
        image: mariadb:10.6.4
        options: --health-cmd="mysqladmin ping" --health-interval=5s --health-timeout=2s --health-retries=3
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: portfolio
        ports:
          - 3307:3306
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: traPortfolio
      - name: Run database linter
        run: |
          source <(curl -sL https://git.io/use-tbls)
          chmod +x ./traPortfolio
          ./traPortfolio --migrate --db-user=root --db-pass=password --db-name=portfolio --db-port=3307
          tbls lint
        env:
          TBLS_DSN: mariadb://root:password@127.0.0.1:3307/portfolio
  spectral:
    name: Spectral
    runs-on: ubuntu-latest
    container:
      image: stoplight/spectral:6.5.1
    steps:
      - uses: actions/checkout@v3
      - name: Spectral checks
        run: spectral lint ./docs/swagger/traPortfolio.v1.yaml
